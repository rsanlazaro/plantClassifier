// Copyright (c) 2022 Kodeco LLC

// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:

// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.

// Notwithstanding the foregoing, you may not use, copy, modify, merge, publish,
// distribute, sublicense, create a derivative work, and/or sell copies of the
// Software in any work that is designed, intended, or marketed for pedagogical
// or instructional purposes related to programming, coding,
// application development, or information technology.  Permission for such use,
// copying, modification, merger, publication, distribution, sublicensing,
// creation of derivative works, or sale is expressly withheld.

// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
// THE SOFTWARE.

import 'dart:io';

import 'package:flutter/material.dart';
import 'package:image/image.dart' as img;
import 'package:image_picker/image_picker.dart';
import '../classifier/classifier.dart';
import '../styles.dart';
import 'plant_photo_view.dart';

const _labelsFileName = 'assets/labels.txt';
// const _modelFileName = 'model.tflite';
const _modelFileName = 'lstm_model.tflite';

class ECGRecogniser extends StatefulWidget {
  const ECGRecogniser({super.key});

  @override
  State<ECGRecogniser> createState() => _ECGRecogniserState();
}

enum _ResultStatus {
  notStarted,
  notFound,
  found,
}

class _ECGRecogniserState extends State<ECGRecogniser> {
  bool _isAnalyzing = false;
  final picker = ImagePicker();
  File? _selectedImageFile;

  // Result
  _ResultStatus _resultStatus = _ResultStatus.notStarted;
  String _plantLabel = ''; // Name of Error Message
  double _accuracy = 0.0;

  late Classifier _classifier;

  @override
  void initState() {
    super.initState();
    _loadClassifier();
  }

  Future<void> _loadClassifier() async {
    debugPrint(
      'Start loading of Classifier with '
      'labels at $_labelsFileName, '
      'model at $_modelFileName',
    );

    final classifier = await Classifier.loadWith(
      labelsFileName: _labelsFileName,
      modelFileName: _modelFileName,
    );
    _classifier = classifier!;
  }

  @override
  Widget build(BuildContext context) {
    return Container(
      color: kBgColor,
      width: double.infinity,
      child: Column(
        mainAxisSize: MainAxisSize.max,
        children: [
          const Spacer(),
          Padding(
            padding: const EdgeInsets.only(top: 30),
            child: _buildTitle(),
          ),
          const SizedBox(height: 20),
          _buildPhotolView(),
          const SizedBox(height: 10),
          _buildResultView(),
          const Spacer(flex: 5),
          _buildPickPhotoButton(
            title: 'Take a photo',
            source: ImageSource.camera,
          ),
          _buildPickPhotoButton(
            title: 'Pick from gallery',
            source: ImageSource.gallery,
          ),
          const Spacer(),
        ],
      ),
    );
  }

  Widget _buildPhotolView() {
    return Stack(
      alignment: AlignmentDirectional.center,
      children: [
        PlantPhotoView(file: _selectedImageFile),
        _buildAnalyzingText(),
      ],
    );
  }

  Widget _buildAnalyzingText() {
    if (!_isAnalyzing) {
      return const SizedBox.shrink();
    }
    return const Text('Analyzing...', style: kAnalyzingTextStyle);
  }

  Widget _buildTitle() {
    return const Text(
      'Plant Recogniser',
      style: kTitleTextStyle,
      textAlign: TextAlign.center,
    );
  }

  Widget _buildPickPhotoButton({
    required ImageSource source,
    required String title,
  }) {
    return TextButton(
      onPressed: () => _onPickPhoto(source),
      child: Container(
        width: 300,
        height: 50,
        color: kColorBrown,
        child: Center(
            child: Text(title,
                style: const TextStyle(
                  fontFamily: kButtonFont,
                  fontSize: 20.0,
                  fontWeight: FontWeight.w600,
                  color: kColorLightYellow,
                ))),
      ),
    );
  }

  void _setAnalyzing(bool flag) {
    setState(() {
      _isAnalyzing = flag;
    });
  }

  void _onPickPhoto(ImageSource source) async {
    final pickedFile = await picker.pickImage(source: source);

    if (pickedFile == null) {
      return;
    }

    final imageFile = File(pickedFile.path);
    setState(() {
      _selectedImageFile = imageFile;
    });

    _analyzeImage(imageFile);
  }

  void _analyzeImage(File image) {
    _setAnalyzing(true);

    // final imageInput = img.decodeImage(image.readAsBytesSync())!;

    final vectorInput = [
      272.00,
      259.00,
      250.00,
      392.00,
      631.00,
      666.00,
      666.00,
      661.00,
      349.00,
      213.00,
      218.00,
      243.00,
      255.00,
      264.00,
      271.00,
      273.00,
      280.00,
      293.00,
      313.00,
      340.00,
      358.00,
      363.00,
      365.00,
      358.00,
      348.00,
      306.00,
      285.00,
      298.00,
      315.00,
      319.00,
      313.00,
      292.00,
      272.00,
      264.00,
      256.00,
      246.00,
      226.00,
      336.00,
      592.00,
      666.00,
      663.00,
      429.00,
      221.00,
      199.00,
      221.00,
      241.00,
      255.00,
      275.00,
      285.00,
      292.00,
      299.00,
      303.00,
      324.00,
      355.00,
      378.00,
      385.00,
      373.00,
      336.00,
      299.00,
      289.00,
      305.00,
      329.00,
      329.00,
      314.00,
      295.00,
      269.00,
      264.00,
      265.00,
      255.00,
      293.00,
      499.00,
      664.00,
      667.00,
      586.00,
      276.00,
      208.00,
      212.00,
      233.00,
      248.00,
      253.00,
      262.00,
      279.00,
      289.00,
      293.00,
      296.00,
      308.00,
      341.00,
      370.00,
      382.00,
      381.00,
      354.00,
      302.00,
      293.00,
      301.00,
      320.00,
      341.00,
      344.00,
      333.00,
      308.00,
      285.00,
      275.00,
      258.00,
      247.00,
      278.00,
      468.00,
      664.00,
      666.00,
      652.00,
      329.00,
      225.00,
      240.00,
      246.00,
      255.00,
      273.00,
      282.00,
      294.00,
      298.00,
      306.00,
      334.00,
      360.00,
      375.00,
      387.00,
      391.00,
      374.00,
      323.00,
      284.00,
      306.00,
      332.00,
      340.00,
      341.00,
      330.00,
      309.00,
      289.00,
      265.00,
      257.00,
      240.00,
      353.00,
      597.00,
      665.00,
      665.00,
      662.00,
      389.00,
      217.00,
      208.00,
      226.00,
      235.00,
      250.00,
      252.00,
      265.00,
      278.00,
      289.00,
      312.00,
      340.00,
      357.00,
      366.00,
      367.00,
      363.00,
      328.00,
      285.00,
      285.00,
      309.00,
      328.00,
      327.00,
      309.00,
      300.00,
      275.00,
      255.00,
      252.00,
      243.00,
      301.00,
      523.00,
      664.00,
      666.00,
      666.00,
      503.00,
      236.00,
      203.00,
      233.00,
      254.00,
      262.00,
      267.00,
      270.00,
      281.00,
      295.00,
      316.00,
      345.00,
      367.00,
      371.00,
      350.00,
      310.00,
      282.00,
      275.00,
      300.00,
      320.00,
      324.00,
      322.00,
      313.00,
      284.00,
      266.00,
      262.00,
      263.00,
      241.00,
      273.00,
      493.00,
      665.00,
      665.00,
      600.00,
      294.00,
      197.00,
      208.00,
      232.00,
      251.00,
      270.00,
      281.00,
      288.00,
      295.00,
      320.00,
      336.00,
      361.00,
      373.00,
      371.00,
      359.00,
      316.00,
      289.00,
      305.00,
      317.00,
      328.00,
      334.00,
      317.00,
      290.00,
      270.00,
      262.00,
      245.00,
      229.00,
      225.00,
      234.00,
      441.00,
      665.00,
      666.00,
      610.00,
      345.00,
      232.00,
      232.00,
      245.00,
      252.00,
      261.00,
      277.00,
      286.00,
      290.00,
      299.00,
      324.00,
      362.00,
      378.00,
      382.00,
      381.00,
      356.00,
      315.00,
      282.00,
      305.00,
      330.00,
      338.00,
      384.00,
      499.00,
      662.00,
      665.00,
      624.00,
      373.00,
      221.00,
      220.00,
      231.00,
      243.00,
      251.00,
      257.00,
      268.00,
      285.00,
      294.00,
      313.00,
      340.00,
      364.00,
      381.00,
      384.00,
      370.00,
      330.00,
      294.00,
      292.00,
      310.00,
      334.00,
      341.00,
      325.00,
      308.00,
      298.00,
      271.00,
      261.00,
      250.00,
      242.00,
      376.00,
      640.00,
      665.00,
      666.00,
      643.00,
      380.00,
      224.00,
      230.00,
      250.00,
      264.00,
      270.00,
      281.00,
      286.00,
      289.00,
      308.00,
      335.00,
      353.00,
      368.00,
      368.00,
      339.00,
      303.00,
      280.00,
      269.00,
      297.00,
      327.00,
      335.00,
      334.00,
      313.00,
      289.00,
      274.00,
      262.00,
      257.00,
      240.00,
      225.00,
      323.00,
      623.00,
      666.00,
      667.00,
      648.00,
      306.00,
      202.00,
      217.00,
      235.00,
      253.00,
      266.00,
      272.00,
      283.00,
      286.00,
      290.00,
      314.00,
      343.00,
      362.00,
      374.00,
      371.00,
      345.00,
      325.00,
      286.00,
      286.00,
      304.00,
      329.00,
      338.00,
      323.00,
      305.00,
      289.00,
      274.00,
      257.00,
      239.00,
      338.00,
      585.00,
      665.00,
      664.00,
      430.00,
      223.00,
      197.00,
      221.00,
      244.00,
      259.00,
      265.00,
      275.00,
      281.00,
      291.00,
      296.00,
      312.00,
      334.00,
      353.00,
      362.00,
      366.00,
      364.00,
      333.00,
      296.00,
      285.00,
      279.00,
      297.00,
      324.00,
      337.00,
      331.00,
      308.00,
      276.00,
      269.00,
      257.00,
      257.00,
      240.00,
      337.00,
      585.00,
      666.00,
      665.00,
      466.00,
      238.00,
      206.00,
      225.00,
      254.00,
      272.00,
      280.00,
      292.00,
      296.00,
      302.00,
      315.00,
      323.00,
      351.00,
      372.00,
      380.00,
      380.00,
      357.00,
      312.00,
      283.00,
      297.00,
      308.00,
      325.00,
      334.00,
      330.00,
      311.00,
      287.00,
      281.00,
      270.00,
      258.00,
      246.00,
      236.00,
      492.00,
      665.00,
      666.00,
      556.00,
      266.00,
      212.00,
      225.00,
      250.00,
      272.00,
      284.00,
      291.00,
      304.00,
      316.00,
      322.00,
      337.00,
      359.00,
      385.00,
      389.00,
      377.00,
      343.00,
      302.00,
      299.00,
      327.00,
      340.00,
      348.00,
      350.00,
      340.00,
      320.00,
      293.00,
      283.00,
      269.00,
      256.00,
      252.00,
      242.00,
      427.00,
      665.00,
      668.00,
      644.00,
      400.00,
      252.00,
      240.00,
      242.00,
      255.00,
      271.00,
      282.00,
      291.00,
      298.00,
      310.00,
      328.00,
      336.00,
      358.00,
      387.00,
      396.00,
      382.00,
      338.00,
      296.00,
      296.00,
      323.00,
      343.00,
      345.00,
      342.00,
      325.00,
      304.00,
      286.00,
      276.00,
      254.00,
      301.00,
      517.00,
      637.00,
      666.00,
      665.00,
      500.00,
      264.00,
      223.00,
      242.00,
      257.00,
      267.00,
      269.00,
      280.00,
      284.00,
      285.00,
      309.00,
      332.00,
      341.00,
      359.00,
      368.00,
      369.00,
      361.00,
      336.00,
      290.00,
      274.00,
      295.00,
      314.00,
      324.00,
      326.00,
      317.00,
      298.00,
      274.00,
      260.00,
      252.00,
      245.00,
      269.00,
      438.00,
      569.00,
      666.00,
      666.00,
      531.00,
      269.00,
      211.00,
      222.00,
      238.00,
      244.00,
      254.00,
      269.00,
      277.00,
      282.00,
      295.00,
      318.00,
      347.00,
      355.00,
      370.00,
      375.00,
      359.00,
      310.00,
      277.00,
      281.00,
      306.00,
      329.00,
      339.00,
      336.00,
      310.00,
      285.00,
      272.00,
      255.00,
      242.00,
      231.00,
      391.00,
      494.00,
      663.00,
      666.00,
      633.00,
      325.00,
      212.00,
      222.00,
      239.00,
      247.00,
      258.00,
      268.00,
      280.00,
      288.00,
      303.00,
      315.00,
      346.00,
      363.00,
      367.00,
      365.00,
      360.00,
      330.00,
      295.00,
      283.00,
      295.00,
      322.00,
      339.00,
      329.00,
      322.00,
      300.00,
      280.00,
      263.00,
      256.00,
      247.00,
      246.00,
      538.00,
      665.00,
      666.00,
      665.00,
      484.00,
      266.00,
      209.00,
      222.00,
      239.00,
      255.00,
      264.00,
      273.00,
      281.00,
      290.00,
      301.00,
      328.00,
      353.00,
      369.00,
      373.00,
      371.00,
      342.00,
      298.00,
      267.00,
      287.00,
      315.00,
      326.00,
      324.00,
      304.00,
      271.00,
      263.00,
      264.00,
      261.00,
      245.00,
      229.00,
      436.00,
      663.00,
      666.00,
      666.00,
      600.00,
      325.00,
      213.00,
      214.00,
      227.00,
      239.00,
      254.00,
      266.00,
      272.00,
      273.00,
      279.00,
      297.00,
      339.00,
      361.00,
      368.00,
      365.00,
      351.00,
      316.00,
      282.00,
      272.00,
      302.00,
      326.00,
      333.00,
      321.00,
      309.00,
      291.00,
      269.00,
      259.00,
      252.00,
      235.00,
      346.00,
      619.00,
      665.00,
      663.00,
      468.00,
      250.00,
      226.00,
      239.00,
      246.00,
      259.00,
      269.00,
      283.00,
      286.00,
      291.00,
      305.00,
      327.00,
      350.00,
      368.00,
      371.00,
      367.00,
      346.00,
      322.00,
      295.00,
      278.00,
      295.00,
      318.00,
      327.00,
      328.00,
      311.00,
      296.00,
      292.00,
      276.00,
      267.00,
      253.00,
      298.00,
      496.00,
      664.00,
      666.00,
      623.00,
      484.00,
      253.00,
      217.00,
      228.00,
      241.00,
      264.00,
      279.00,
      281.00,
      290.00,
      296.00,
      306.00,
      319.00,
      341.00,
      365.00,
      373.00,
      357.00,
      319.00,
      293.00,
      275.00,
      281.00,
      301.00,
      321.00,
      331.00,
      323.00,
      290.00,
      266.00,
      259.00,
      259.00,
      255.00,
      243.00,
      350.00,
      617.00,
      665.00,
      668.00,
      660.00,
      419.00,
      233.00,
      223.00,
      241.00,
      254.00,
      266.00,
      274.00,
      278.00,
      284.00,
      299.00,
      314.00,
      342.00,
      361.00,
      374.00,
      372.00,
      341.00,
      312.00,
      288.00,
      267.00,
      292.00,
      318.00,
      333.00,
      328.00,
      298.00,
      271.00,
      261.00,
      260.00,
      259.00,
      248.00,
      284.00,
      524.00,
      665.00,
      666.00,
      665.00,
      536.00,
      265.00,
      213.00,
      233.00,
      253.00,
      261.00,
      272.00,
      279.00,
      284.00,
      295.00,
      305.00,
      326.00,
      351.00,
      372.00,
      379.00,
      365.00,
      354.00,
      312.00,
      277.00,
      278.00,
      310.00,
      328.00,
      329.00,
      317.00,
      296.00,
      284.00,
      268.00,
      259.00,
      247.00,
      238.00,
      404.00,
      641.00,
      665.00,
      649.00,
      522.00,
      298.00,
      210.00,
      213.00,
      229.00,
      246.00,
      264.00,
      269.00,
      272.00,
      275.00,
      289.00,
      311.00,
      336.00,
      354.00,
      365.00,
      363.00,
      339.00,
      301.00,
      286.00,
      274.00,
      298.00,
      327.00,
      336.00,
      325.00,
      302.00,
      283.00,
      279.00,
      273.00,
      255.00,
      237.00,
      246.00,
      522.00,
      665.00,
      665.00,
      550.00,
      300.00,
      201.00,
      214.00,
      239.00,
      252.00,
      265.00,
      283.00,
      297.00,
      301.00,
      304.00,
      307.00,
      329.00,
      359.00,
      376.00,
      377.00,
      366.00,
      327.00,
      291.00,
      290.00,
      319.00,
      340.00,
      344.00,
      333.00,
      300.00,
      284.00,
      273.00,
      265.00,
      261.00,
      250.00,
      386.00,
      652.00,
      666.00,
      664.00,
      462.00,
      260.00,
      237.00,
      245.00,
      255.00,
      263.00,
      282.00,
      295.00,
      302.00,
      307.00,
      322.00,
      331.00,
      333.00,
      362.00,
      377.00,
      389.00,
      383.00,
      360.00,
      314.00,
      296.00,
      286.00,
      310.00,
      342.00,
      354.00,
      345.00,
      320.00,
      301.00,
      280.00,
      271.00,
      266.00,
      256.00,
      319.00,
      536.00,
      665.00,
      666.00,
      581.00,
      333.00,
      222.00,
      221.00,
      242.00,
      256.00,
      266.00,
      275.00,
      286.00,
      301.00,
      314.00,
      320.00,
      336.00,
      355.00,
      371.00,
      377.00,
      364.00,
      328.00,
      285.00,
      287.00,
      295.00,
      313.00,
      334.00,
      337.00,
      326.00,
      301.00,
      284.00,
      271.00,
      258.00,
      253.00,
      239.00,
      387.00,
      651.00,
      665.00,
      666.00,
      464.00,
      253.00,
      235.00,
      241.00,
      259.00,
      269.00,
      273.00,
      283.00,
      293.00,
      307.00,
      318.00,
      346.00,
      359.00,
      366.00,
      388.00,
      386.00,
      353.00,
      311.00,
      293.00,
      297.00,
      321.00,
      332.00,
      344.00,
      337.00,
      311.00,
      286.00,
      269.00,
      259.00,
      240.00,
      228.00,
      298.00,
      531.00,
      665.00,
      667.00,
      584.00,
      280.00,
      225.00,
      239.00,
      249.00,
      257.00,
      262.00,
      275.00,
      289.00,
      293.00,
      309.00,
      333.00,
      346.00,
      364.00,
      374.00
    ];

    final resultCategory = _classifier.predict(vectorInput);
    debugPrint(resultCategory.toString());
    debugPrint('xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx');

    final result = resultCategory.score >= 0.8
        ? _ResultStatus.found
        : _ResultStatus.notFound;
    final plantLabel = resultCategory.label;
    final accuracy = resultCategory.score;

    _setAnalyzing(false);

    setState(() {
      _resultStatus = result;
      _plantLabel = plantLabel;
      _accuracy = accuracy;
    });
  }

  Widget _buildResultView() {
    var title = '';

    if (_resultStatus == _ResultStatus.notFound) {
      title = 'Fail to recognise';
    } else if (_resultStatus == _ResultStatus.found) {
      title = _plantLabel;
    } else {
      title = '';
    }

    //
    var accuracyLabel = '';
    if (_resultStatus == _ResultStatus.found) {
      accuracyLabel = 'Accuracy: ${(_accuracy * 100).toStringAsFixed(2)}%';
    }

    return Column(
      children: [
        Text(title, style: kResultTextStyle),
        const SizedBox(height: 10),
        Text(accuracyLabel, style: kResultRatingTextStyle)
      ],
    );
  }
}
